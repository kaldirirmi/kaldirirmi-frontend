
<link rel="import" href="../model/kal-tagcloud.html">
<link rel="import" href="../model/kal-nav-content.html">

<link rel="import" href="./kal-related-game.html">
<link rel="import" href="./kal-news-popular.html">
<link rel="import" href="../kal-copyright.html">


<dom-module id="kal-selected-news">
    <template>
        <style>
            :host {
                display: block
            }
        </style>

        <iron-ajax id="getselectednews" url="/h/main?fm=get-news-info&a=[[url]]" handle-as="json" on-response="_onResponse" loading="{{loading}}"></iron-ajax>

        <app-toolbar>
            <!-- <paper-icon-button icon="arrow-back" on-tap="onBackToAll"></paper-icon-button> -->
            <a id="back" href="/news">
                <paper-icon-button icon="icons:arrow-back" on-tap="onBackToAll"></paper-icon-button>
            </a>
            <span>Geri Dön</span>
        </app-toolbar>

        <div hidden$=[[!loading]] class="loader-pac-content">
            <loader-pac></loader-pac>
        </div>
        <div hidden$="[[loading]]">
            <template is="dom-if" if={{isNews}}>
                <form id="formkleine" is="iron-form" action="/h/main" method="post">
                    <input type="hidden" name="fm" value="post-kleine-container-news" />
                    <input type="hidden" id="container" name="container" value="[[newsinfo.id]]" />
                    <input type="hidden" id="kleine" name="kleine" value="[[newsinfo.viewcount]]" />
                </form>
                <div id="news-page">
                    <div id="news-page-header">
                        <paper-icon-button id="pibBackNews" icon="arrow-back" onclick="load(); location.href='/haberler';"></paper-icon-button>
                        <paper-tooltip for="pibBackNews" position="left" animation-delay="200">Haberlere Geri Dön</paper-tooltip>
                        <h1>
                            [[newsinfo.title]]
                        </h1>
                    </div>
                </div>
                <parallax-layers>
                    <div depth="-0.5" class="fullbleed" style="margin:0 auto;">
                        <iron-image src="[[newsinfo.picture]]" sizing="cover" preload fade alt="[[newsinfo.title]]"></iron-image>
                    </div>
                </parallax-layers>
                <kal-nav-content datatable="kalnews" dataid="[[newsinfo.id]]"></kal-nav-content>
                <div id="news-page-container" itemscope itemtype="http://schema.org/Article">
                    <div id="newscontent">
                        <div id="panel">
                            <div id="options">
                                <div id="options_share_buttons" class="addthis_inline_share_toolbox"></div>
                            </div>
                            <div id="panel-contents">
                                <h2 itemprop="headline">
                                    [[newsinfo.title]]
                                </h2>
                            </div>
                        </div>
                        <div id="news-content-details">
                            <div class="news-subtitle-container">
                                <div class="news-subtitle">
                                    <h3 itemprop="alternativeHeadline">
                                        [[newsinfo.subtitle]]
                                    </h3>
                                </div>
                                <div class="news-release">
                                    <h3>
                                        [[newsinfo.releasedate]]
                                    </h3>

                                    <time hidden datetime="[[newsinfo.releasedate]]" itemprop="dateCreated">
                                        [[newsinfo.releasedate]]
                                    </time>
                                    <time hidden datetime="[[newsinfo.releasedate]]" itemprop="datePublished">
                                        [[newsinfo.releasedate]]
                                    </time>

                                </div>
                            </div>
                            <hr themed-reverse="" class="style-scope package-tile kaldirirmi-profile-forum">
                            <div class="news-description">
                                <div class="news-details" itemprop="mainEntityOfPage">
                                    <p>
                                        [[newsinfo.details]]
                                    </p>
                                    <kal-related-game relatedgameid="[[_getRelatedGame(newsinfo)]]" currentnewsid="[[newsinfo.id]]"></kal-related-game>
                                    <hr themed-reverse="" class="style-scope package-tile kaldirirmi-profile-forum">
                                    <div id="news-details-publisher">
                                        <div itemprop="thumbnailUrl" class="news-details-publisher-container">
                                            <iron-image itemprop="image" src="https://cdn.kaldirirmi.com/images/user/avatar/default-user-avatar.png" sizing="cover" alt="[[newsinfo.publisher]]"></iron-image>
                                            <h3 itemprop="publisher">
                                                [[newsinfo.publisher]]
                                            </h3>
                                        </div>
                                        <div class="news-details-publisher-container">
                                            <iron-icon icon="image:collections"></iron-icon>
                                            <h3 itemprop="genre">
                                                [[newsinfo.category]]
                                            </h3>
                                            <iron-icon icon="image:remove-red-eye"></iron-icon>
                                            <h3>
                                                [[newsinfo.viewcount]]
                                            </h3>
                                        </div>

                                    </div>
                                    <hr themed-reverse="" class="style-scope package-tile kaldirirmi-profile-forum">

                                    <div id="disqus_thread"></div>
                                    <script>
                                        var disqus_config = function () {
                                            this.page.url = 'https://kaldirirmi.com/haber/' + '[[newsinfo.url]]';
                                            this.page.identifier = '[[newsinfo.url]]';
                                        };
                                        (function () { // DON'T EDIT BELOW THIS LINE
                                            var d = document,
                                                s = d.createElement('script');
                                            s.src = '//kaldirirmi-com.disqus.com/embed.js';
                                            s.setAttribute('data-timestamp', +new Date());
                                            (d.head || d.body).appendChild(s);
                                        })();
                                    </script>
                                </div>
                                <div class="news-popular-news">
                                    <div class="rightside-tagcloud">
                                        <kal-tagcloud contenttitle="[[newsinfo.title]]" contenttable="[[tablename]]"></kal-tagcloud>
                                    </div>
                                    <div class="rightside-popular-news">
                                        <kal-news-popular currentnews="[[newsinfo.id]]"></kal-news-popular>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <kal-copyright></kal-copyright>
                        <!-- <kaldirirmi-sitecopyright></kaldirirmi-sitecopyright> -->
                    </div>
                </div>
                <script id="dsq-count-scr" src="https://kaldirirmi-com.disqus.com/count.js" async></script>
            </template>
            <template is="dom-if" if={{!isNews}}>
                <span>Böyle bir haber bulunmamaktadır!</span>
            </template>
        </div>

    </template>

    <script>
        /**
         * `kal-selected-news` Description
         *
         * @summary ShortDescription.
         * @customElement
         * @polymer
         * @extends {Polymer.Element}
         */
        class KalSelectedNews extends Polymer.Element {
            /**
             * String providing the tag name to register the element under.
             */
            static get is() {
                return 'kal-selected-news';
            }

            /**
             * Object describing property-related metadata used by Polymer features
             */
            static get properties() {
                return {
                    url: {
                        type: String,
                        notify: true
                    },
                    isNews: Boolean,
                    newsinfo: {
                        type: Object,
                        value: null,
                    },
                };
            }



            static get observers() {
                return [
                    '_selectedNewsChanged(url)'
                ]
            }

            /**
             * Use for one-time configuration of your component after local DOM is
             * initialized.
             */
            ready() {
                super.ready();

                // When possible, use afterNextRender to defer non-critical
                // work until after first paint.
                Polymer.RenderStatus.afterNextRender(this, function () {
                    // console.log('ready', this.url);
                    this.$.formkleine.submit();
                });

            }

            /**
             * An attribute was added, removed, updated, or replaced. Also called for
             * initial values when an element is created by the parser, or upgraded.
             * Note: only attributes listed in the observedAttributes property will
             * receive this callback. 
             */
            attributeChangedCallback(attrName, oldVal, newVal) {
                // console.log('attributeChangedCallback', attrName);
            }

            /**
             * Called every time the element is inserted into the DOM. Useful for 
             * running setup code, such as fetching resources or rendering.
             * Generally, you should try to delay work until this time.
             */
            connectedCallback() {
                super.connectedCallback();

                // console.log('connectedCallback', this.url)


            }

            /**
             * Instance of the element is created/upgraded. Useful for initializing
             * state, set up event listeners, create shadow dom.
             * @constructor
             */
            constructor() {
                super();
                // console.log('constructor', this.url)
            }

            _selectedNewsChanged(newVal, oldVal) {

                // we are starting here..
                this._clearState();
                this._debounceWork();
                // console.log('CurrentUrl: ', newVal, oldVal);
            }

            _onResponse(event) {
                var response = event.detail.response;

                console.log('kal-selected-news response: ', response);

                if (response !== null) {
                    this.set('isNews', true);

                    this.set('newsinfo', response);

                } else
                    this.set('isNews', false);

            }

            _debounceWork() {
                //Polymer.Async.timeOut.after(400)
                this._debounceJob = Polymer.Debouncer.debounce(
                    this._debounceJob,
                    Polymer.Async.microTask,
                    () => {
                        this._generateRequest();
                    });
            }

            _clearState() {
                this.set('newsinfo', null);
            }

            _generateRequest() {
                if (this.$.getselectednews.lastRequest) {
                    this.$.getselectednews.lastRequest.abort();
                }
                this.$.getselectednews.generateRequest();
            }

            _getRelatedGame(newsinfo) {
                return newsinfo.relatedgames.Split(',')[0];
            }
        }

        window.customElements.define(KalSelectedNews.is, KalSelectedNews);
    </script>
</dom-module>